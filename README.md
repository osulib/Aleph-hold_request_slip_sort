# Sort hold slips generated by ue06 by CallNo

## Purpose, Description

ALEPH hold request daemon UE-06 creates huge amount of xml files with hold requests, one file per each request, during nights or weekends when library is closed. This causes:
1. Printed slips must be sorted manually by staff before they use them to look for items in shelves
2. Large amount of files printed in the same time may cause that some of the slips are not printed. Hard to say, which part of printing process makes this (Aleph print daemon, HTMLPrint, Windows printer driver, Printer).

Shell script run by schedule every working day before staff starts to work takes individual hold files, sorts them by Call Nos. and merge them to one or more bigger files. Staff must not sort printed slips and some errors in printing could be avoided. The same or different xslt template can be used for printing this file with more slips.

## Implementation, Detailed description

### hold_request_slip2print_sort.csh

Download CSH script `hold_request_slip2print_sort.csh` from this repository and save it anywhere on server with rights to access Aleph files. The destination directory might be some you use for custom scripts. Make this file executable: `chmod +x hold_request_slip2print_sort.csh.sql`

This file **hold_request_slip2print_sort.csh** run once a day before starting working hours takes all hold-slip files in ADM library print directory. For each Aleph Print ID, i.e. file extension, it sorts the files according to <z30-call-no-key> element a creates one result file names `xxx5x_multi_sorted_yyyymmdd.printID` where xxx5x is ADM library, yyyymmdd is actual date and printID is the real used print id as in original files. This file has structure:

`    ## - XML_XSL`

    <?xml version="1.0"?>
    <printout>
       <form-name>hold-request-slip</form-name>
       <form-language>CZE</form-language>
       <form-format>00</form-format>
       <subject/>
       <printout>
          {{..slip 1..}}
       </printout>
       <printout>
          {{..slip 2..}}
       </printout>
       <printout>
          {{..slip 3..}}
       </printout>
       ... ...
    </printout>


***

Edit this file `hold_request_slip2print_sort.csh` and modify general parameters on line 26 on :

`set admBase = "xxx50" - Your ALEPH ADM base, in lower case

`set printDir = "$alephe_dev/$admBase/print"` - by default, this must not be changed - print directory`

Following 3 variable determine which xslt print template, language and template form (00,01,90 etc.) will be used for processing result "multi" file. It is recommended to use the same xslt template as for simple one-file hold slips. See an example of such file here and the text below. If following 3 variables are left empty in this code, they will be taken from the first file the script will process. Yet, you should set them here.   

   `set xslTemplateName = "hold-request-slip"` - xslt template name as defined in original node <form-name>

   `set xslTemplateLang = "ENG"` - xslt template language as defined in original node <form-language>

   `set xslTemplateFormat = "00"` - xslt template format as defined in original node <form-format>

If the library has a large quantity of slips printed after night or weekend break, it may cause too large result "multi" files, which can cause problems with Java memory during Saxon XSLT transformation on client PC, or on printers. If the following variable is set to non-zero or non-empty, each result file will not contain more than here set slips. A new result file will be created after reaching this limit. Result file names are then: 

`xxx5x_multi_sorted_yyyymmdd.0.printID`, `xxx5x_multi_sorted_yyyymmdd.1.printID`, `xxx5x_multi_sorted_yyyymmdd.2.printID` etc. It has been tested as safe to up to value of 100 during development.

   `set separateAfterNSlips = "100"` 

   `set logfile = "/{some_path}/hold_request_slip2print_sort.log"` - path and file where log of the procedure is stored

   `set admin_email = 'aleph_admin@libary.xx'` - errors are sent there

### XSLT template

In default simple slip files, the data are nested into <printout> elements. In the "multi" file all these <printout>s have one more root element <printout> - see example above.
For this difference, you can define special xslt template for processing these "multi" files. Still, it is possible to modify common xslt `hold-request-slip.xslt` to be able to process both common one-slip files and multi files created here. See an example of such file in this repository.
Create/modify this file in your ./form_lng directory and recreate xslt template pack by running: util + i + 6

### Scheduling
The `hold_request_slip2print_sort.csh` file should be run regularly scheduled by $alephe_tab/job_list or another instrument. You should schedule its running each working day several minutes before library staff starts to print the slips.

Furthermore, the script should not be run on time, when hold request UE06 is active due to possible, though not probable, colision of creating new slip files by UE06 during script running. UE06 working ours are set in environment variable `ue_06_active_hours`. This variable is usually set in aleph in `$alephe_root/aleph_start` or `uNN_N/xxx50/tab/prof_library` setting scripts. You may modifing this value when planning when to run the script.

If the script is run with -f argument (`./hold_request_slip2print_sort.csh -f`), the check of running UE06 will be passed and files processed anyway. Still, it is not recommended for production use.

## Created by

Matyas Franciszek Bajger, Moravian-Silesian Research Library in Ostrava, bajger@svkos.cz, http://www.svkos.cz

## License
GNU GPL

## Developed and live at
University of Ostrava Library http://knihovna.osu.cz , Moravian-Silesian Research Library in Ostrava, http://www.svkos.cz
